# Build stage
FROM node:22-alpine AS build

WORKDIR /app

# Copy package.json, package-lock.json, and Jest configuration
COPY package*.json jest.config.js ./

# Install all dependencies including dev dependencies
RUN npm ci && \
    npm cache clean --force

# Runtime stage
FROM node:22-alpine

WORKDIR /app

# Copy dependencies from build stage
COPY --from=build /app/node_modules /app/node_modules

# Copy Jest configuration
COPY jest.config.js ./

# Copy source code and tests
COPY ./index.js ./utils.js ./answerMap.json ./
COPY ./tests ./tests

# Run tests with coverage
CMD ["npm", "run", "test:coverage"]